@model IEnumerable<AspnetCoreMvcStarter.Models.MonthlyKpiReport>
@using AspnetCoreMvcStarter.Models

@{
    ViewData["Title"] = "KPI Reports";
    var currentUserRole = Context.Session.GetString("UserRole");
    bool canGenerate = currentUserRole == UserRole.Admin.ToString() || currentUserRole == UserRole.Leader.ToString();
    int currentMonth = ViewData["CurrentMonth"] != null ? Convert.ToInt32(ViewData["CurrentMonth"]) : DateTime.Now.Month;
    int currentYear = ViewData["CurrentYear"] != null ? Convert.ToInt32(ViewData["CurrentYear"]) : DateTime.Now.Year;
}

<h2 style="text-align:center">Báo Cáo KPI Tháng</h2>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (canGenerate)
{
    <div class="mb-3">
        <form asp-action="Generate" method="get" class="d-inline">
            <input type="hidden" name="month" value="@currentMonth" />
            <input type="hidden" name="year" value="@currentYear" />
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus"></i> Tạo báo cáo tháng @currentMonth/@currentYear
            </button>
        </form>
    </div>
}

<div class="mb-3">
    <form asp-action="Index" method="get">
        <div class="row">
            <div class="col-md-3">
                <label for="month" class="form-label">Tháng</label>
                <select name="month" id="month" class="form-select">
                    @for (int i = 1; i <= 12; i++)
                    {
                        <option value="@i" selected="@(i == currentMonth)">@i</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label for="year" class="form-label">Năm</label>
                <select name="year" id="year" class="form-select">
                    @for (int i = DateTime.Now.Year - 5; i <= DateTime.Now.Year + 1; i++)
                    {
                        <option value="@i" selected="@(i == currentYear)">@i</option>
                    }
                </select>
            </div>
            <div class="col-md-3 align-self-end">
                <button type="submit" class="btn btn-primary">Lọc</button>
            </div>
        </div>
    </form>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Người dùng</th>
                <th>Tháng</th>
                <th>Năm</th>
                <th>Tổng điểm KPI</th>
                <th>Công việc hoàn thành</th>
                <th>Công việc chờ</th>
                <th>Tỷ lệ hoàn thành</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                @foreach (var report in Model)
                {
                    <tr>
                        <td>@report.Id</td>
                        <td>@(report.User?.Name ?? "N/A")</td>
                        <td>@report.Month</td>
                        <td>@report.Year</td>
                        <td>@report.TotalKpiPoints</td>
                        <td>@report.CompletedTasks</td>
                        <td>@report.PendingTasks</td>
                        <td>@(report.CompletionRate.ToString("F2"))%</td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="8" class="text-center">Không có báo cáo nào cho tháng @currentMonth/@currentYear</td>
                </tr>
            }
        </tbody>
    </table>
</div>
